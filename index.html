<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mangais Tournament Pro</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style> 
        body { background-color: #f1f5f9; color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: 90px; }
        .page-enter { animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; margin-bottom: 12px; }
        .user-bubble { background-color: #064e3b; color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-left: auto; }
        .ai-bubble { background-color: white; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-left-radius: 4px; align-self: flex-start; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-full flex flex-col max-w-md mx-auto bg-slate-50 shadow-2xl overflow-hidden relative"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'firebase/auth';

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDSS05uLPrAKyPt6yBrNt1-xyWmHpJ0L-w",
            authDomain: "mangais-golf.firebaseapp.com",
            projectId: "mangais-golf",
            storageBucket: "mangais-golf.firebasestorage.app",
            messagingSenderId: "107579479973",
            appId: "1:107579479973:web:2a57115ea51d296f3ffa4c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        const API_KEY = "AIzaSyBYd4jCxHZohdIHdu6fCmlU7JFvD2wAL2c"; 

        // --- DATA ---
        const HOLES = [
            { number: 1, par: 5, si: 16, dist: 485, tip: "Wide fairway. Green accessible in 3." },
            { number: 2, par: 4, si: 14, dist: 365, tip: "Avoid cross bunkers." },
            { number: 3, par: 4, si: 8, dist: 390, tip: "Play left side." },
            { number: 4, par: 3, si: 12, dist: 145, tip: "Watch the wind." },
            { number: 5, par: 5, si: 2, dist: 520, tip: "Hardest front hole.", hazard: "croc" },
            { number: 6, par: 4, si: 18, dist: 355, tip: "Birdie chance." },
            { number: 7, par: 4, si: 10, dist: 375, tip: "Accuracy over power." },
            { number: 8, par: 3, si: 6, dist: 175, tip: "Over wetland. Club up.", hazard: "croc" },
            { number: 9, par: 4, si: 4, dist: 400, tip: "Avoid water right." },
            { number: 10, par: 4, si: 3, dist: 410, tip: "Long drive needed." },
            { number: 11, par: 3, si: 11, dist: 160, tip: "Avoid bunkers." },
            { number: 12, par: 5, si: 13, dist: 490, tip: "Go for green in 2?" },
            { number: 13, par: 4, si: 9, dist: 385, tip: "Keep left.", hazard: "croc" },
            { number: 14, par: 4, si: 7, dist: 395, tip: "Precision key." },
            { number: 15, par: 3, si: 17, dist: 135, tip: "Don't go long." },
            { number: 16, par: 4, si: 5, dist: 405, tip: "Two strong shots." },
            { number: 17, par: 5, si: 1, dist: 540, tip: "Play safe for Par." },
            { number: 18, par: 4, si: 15, dist: 370, tip: "Enjoy the walk.", hazard: "croc" }
        ];

        // --- ICONS COMPONENT ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]); 
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- COMPONENTS ---

        // 1. DASHBOARD
        const Dashboard = ({ user, setView }) => (
            <div className="flex-1 overflow-y-auto bg-slate-50 safe-pb page-enter">
                <div className="bg-emerald-900 text-white p-6 pt-12 rounded-b-3xl shadow-xl">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-emerald-200 text-xs font-bold uppercase tracking-wider mb-1">Welcome back</p>
                            <h1 className="text-2xl font-bold">{user.displayName || "Golfer"}</h1>
                            <div className="inline-flex items-center gap-2 mt-3 bg-white/10 px-3 py-1.5 rounded-lg border border-white/10 backdrop-blur-sm">
                                <Icon name="activity" size={14} className="text-emerald-400" />
                                <span className="text-xs font-bold">HCP 18.0</span>
                            </div>
                        </div>
                        <div className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center border border-white/10">
                            <Icon name="bell" size={18} />
                        </div>
                    </div>
                </div>

                <div className="p-5 space-y-4 -mt-6">
                    {/* Tournament Button */}
                    <button onClick={() => setView('setup')} className="w-full bg-white p-5 rounded-2xl shadow-lg border border-slate-100 flex items-center justify-between group active:scale-[0.98] transition-transform duration-200">
                        <div className="text-left">
                            <div className="flex items-center gap-2 mb-1">
                                <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                <span className="text-xs font-bold text-emerald-600 uppercase tracking-wide">Tournament Mode</span>
                            </div>
                            <span className="block text-xl font-bold text-slate-800">Mangais Championship</span>
                            <span className="text-xs text-slate-400">Multi-Flight ‚Ä¢ Live Scoring</span>
                        </div>
                        <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center border border-emerald-100 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                            <Icon name="trophy" fill="currentColor" size={20} />
                        </div>
                    </button>

                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={() => setView('wildlife')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <span className="text-3xl">üêä</span>
                            <div className="text-sm font-bold text-slate-700">Wildlife</div>
                        </button>
                        <button onClick={() => setView('ai-caddy')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <span className="text-3xl">ü§ñ</span>
                            <div className="text-sm font-bold text-slate-700">AI Caddy</div>
                        </button>
                    </div>
                </div>
            </div>
        );

        // 2. SETUP (Tournament/Flights)
        const SetupView = ({ setView, setPlayers, setGameFormat }) => {
            const [flights, setFlights] = useState([[{id: 1, name: 'You', hcp: 18}]]);
            const [format, setFormat] = useState('stableford'); 

            const addPlayer = (fIdx) => {
                if (flights[fIdx].length >= 4) return;
                const newF = [...flights];
                newF[fIdx].push({ id: Date.now(), name: `Player ${newF[fIdx].length+1}`, hcp: 18 });
                setFlights(newF);
            };
            
            const addFlight = () => {
                setFlights([...flights, [{ id: Date.now(), name: 'Player 1', hcp: 18 }]]);
            };

            const updatePlayer = (fIdx, pIdx, k, v) => {
                const newF = [...flights];
                newF[fIdx][pIdx][k] = v;
                setFlights(newF);
            };

            const start = () => {
                const all = [];
                flights.forEach((f, i) => f.forEach(p => all.push({ ...p, flight: i+1, scores: {} })));
                setPlayers(all);
                setGameFormat(format);
                setView('play');
            };

            return (
                <div className="flex-1 bg-slate-50 flex flex-col h-full p-5 pt-12 overflow-y-auto page-enter">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={() => setView('dashboard')} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                        <h2 className="text-lg font-bold text-slate-800">Tournament Setup</h2>
                        <div className="w-8"></div>
                    </div>

                    <div className="bg-white p-1 rounded-xl shadow-sm border border-slate-200 flex mb-6">
                        <button onClick={() => setFormat('stroke')} className={`flex-1 py-2.5 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition ${format === 'stroke' ? 'bg-emerald-900 text-white shadow-md' : 'text-slate-500'}`}>
                            <Icon name="hash" size={16} /> Stroke
                        </button>
                        <button onClick={() => setFormat('stableford')} className={`flex-1 py-2.5 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition ${format === 'stableford' ? 'bg-emerald-900 text-white shadow-md' : 'text-slate-500'}`}>
                            <Icon name="calculator" size={16} /> Stableford
                        </button>
                    </div>

                    <div className="space-y-4">
                        {flights.map((f, i) => (
                            <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                                    <span className="text-xs font-bold text-emerald-700 uppercase tracking-wider">Flight {i + 1}</span>
                                    <span className="text-xs font-medium text-slate-400">{f.length}/4 Players</span>
                                </div>
                                <div className="space-y-3">
                                    {f.map((p, j) => (
                                        <div key={p.id} className="flex gap-2 items-center">
                                            <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">{j+1}</div>
                                            <input className="flex-1 bg-transparent border-b border-slate-200 py-1.5 font-semibold text-slate-700 focus:border-emerald-500 outline-none text-sm" value={p.name} onChange={(e) => updatePlayer(i, j, 'name', e.target.value)} />
                                            <input type="number" className="w-12 bg-transparent border-b border-slate-200 py-1.5 font-semibold text-slate-700 text-center focus:border-emerald-500 outline-none text-sm" value={p.hcp} onChange={(e) => updatePlayer(i, j, 'hcp', Number(e.target.value))} />
                                        </div>
                                    ))}
                                    {f.length < 4 && <button onClick={() => addPlayer(i)} className="w-full py-2.5 mt-2 border border-dashed border-slate-300 text-slate-400 rounded-lg font-bold text-xs hover:border-emerald-400 hover:text-emerald-600 transition flex items-center justify-center gap-1"><Icon name="plus" size={14}/> Add Player</button>}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={addFlight} className="mt-4 w-full py-3 border-2 border-slate-200 text-slate-400 rounded-xl font-bold text-sm hover:border-emerald-500 flex items-center justify-center gap-2"><Icon name="users" size={16}/> Add Another Flight</button>
                    
                    <button onClick={start} className="mt-8 w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-200 text-base flex items-center justify-center gap-2 active:scale-95 transition">
                        Start Tournament <Icon name="arrow-right" size={18} />
                    </button>
                </div>
            );
        };

        // 3. GAME VIEW
        const GameView = ({ players, setPlayers, setView, gameFormat, holeIdx, setHoleIdx }) => {
            const [activePlayerId, setActivePlayerId] = useState(0); 
            const [isConfirmed, setIsConfirmed] = useState(false);
            
            const hole = HOLES[holeIdx];
            const activePlayer = players[activePlayerId];
            const score = activePlayer.scores[hole.number] || hole.par;

            useEffect(() => setIsConfirmed(false), [activePlayerId, holeIdx]);

            const updateScore = (val) => {
                setIsConfirmed(false);
                const newPlayers = [...players];
                newPlayers[activePlayerId].scores[hole.number] = Math.max(1, score + val);
                setPlayers(newPlayers);
            };

            const confirmScore = () => setIsConfirmed(true);
            const getPoints = (g) => Math.max(0, hole.par - (g - (activePlayer.hcp >= hole.si ? 1 : 0)) + 2);
            
            return (
                <div className="flex-1 flex flex-col h-full bg-slate-50 relative safe-pb page-enter">
                    <div className="bg-emerald-900 pt-10 pb-6 px-4 rounded-b-3xl shadow-lg z-10 text-white">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={()=>setView('dashboard')}><Icon name="home" className="text-emerald-200" /></button>
                            <span className="font-bold text-emerald-100 text-xs uppercase tracking-widest">Hole {hole.number}</span>
                            <button onClick={()=>setView('leaderboard')}><Icon name="list" className="text-emerald-200" /></button>
                        </div>
                        <div className="flex justify-between items-end">
                            <div>
                                <h2 className="text-4xl font-black mb-1">{hole.par} <span className="text-lg font-medium opacity-60">PAR</span></h2>
                                <div className="flex gap-3 text-xs font-bold text-emerald-300">
                                    <span>SI {hole.si}</span>
                                    <span>‚Ä¢</span>
                                    <span>{hole.dist}m</span>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setHoleIdx(Math.max(0, holeIdx-1))} disabled={holeIdx===0} className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 disabled:opacity-30"><Icon name="chevron-left" /></button>
                                <button onClick={()=>setHoleIdx(Math.min(17, holeIdx+1))} disabled={holeIdx===17} className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 disabled:opacity-30"><Icon name="chevron-right" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="flex overflow-x-auto px-4 py-3 gap-2 bg-white border-b border-slate-100 no-scrollbar">
                        {players.map((p, i) => (
                            <button key={i} onClick={()=>setActivePlayerId(i)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all ${activePlayerId === i ? 'bg-emerald-900 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>
                                {p.name.split(' ')[0]}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-6 space-y-6">
                        <div className={`w-full max-w-xs bg-white rounded-3xl p-6 shadow-xl border transition-all duration-300 ${isConfirmed ? 'border-emerald-500 ring-2 ring-emerald-100' : 'border-slate-100'}`}>
                            <div className="text-center mb-6">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Scoring For</span>
                                <span className="text-lg font-bold text-slate-800">{activePlayer.name}</span>
                            </div>

                            <div className="flex items-center justify-between mb-8">
                                <button onClick={()=>updateScore(-1)} className="w-14 h-14 rounded-full bg-slate-50 text-slate-600 flex items-center justify-center border border-slate-200 active:scale-95 transition"><Icon name="minus" /></button>
                                <div className="text-center">
                                    <span className="text-7xl font-black text-slate-900 block leading-none">{score}</span>
                                    {gameFormat === 'stableford' && <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full mt-2 inline-block">{getPoints(score)} PTS</span>}
                                </div>
                                <button onClick={()=>updateScore(1)} className="w-14 h-14 rounded-full bg-emerald-600 text-white flex items-center justify-center shadow-lg shadow-emerald-200 active:scale-95 transition"><Icon name="plus" /></button>
                            </div>

                            <button onClick={confirmScore} className={`w-full py-3.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all ${isConfirmed ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-slate-900 text-white shadow-lg hover:bg-slate-800'}`}>
                                {isConfirmed ? <><Icon name="check" size={18}/> Score Saved</> : "Confirm Score"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. LEADERBOARD
        const LeaderboardView = ({ players, setView, gameFormat }) => {
            const [expandedId, setExpandedId] = useState(null);
            const getPoints = (g, hcp, si, par) => Math.max(0, par - (g - (hcp >= si ? 1 : 0)) + 2);
            const calcStats = (p) => {
                let gross = 0, pts = 0;
                HOLES.forEach(h => {
                    const s = p.scores[h.number];
                    if(s) { gross += s; pts += getPoints(s, p.hcp, h.si, h.par); }
                });
                return { gross, pts };
            }
            const sortedPlayers = [...players].sort((a, b) => {
                const sA = calcStats(a), sB = calcStats(b);
                return gameFormat === 'stableford' ? sB.pts - sA.pts : sA.gross - sB.gross;
            });

            return (
                <div className="flex-1 bg-slate-50 flex flex-col h-full safe-pb overflow-hidden page-enter">
                    <div className="bg-emerald-900 p-6 pt-12 pb-6 shadow-lg text-white shrink-0">
                        <div className="flex justify-between items-center mb-2">
                            <button onClick={() => setView('play')} className="font-bold text-emerald-200"><Icon name="arrow-left" /></button>
                            <h2 className="font-bold text-xl">Leaderboard</h2>
                            <div className="w-6"></div>
                        </div>
                        <div className="flex justify-center gap-4 text-xs font-bold text-emerald-300 uppercase tracking-widest">
                            <span>{gameFormat === 'stableford' ? 'Stableford' : 'Stroke Play'}</span>
                            <span>‚Ä¢</span>
                            <span>{players.length} Players</span>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {sortedPlayers.map((p, i) => {
                            const stats = calcStats(p);
                            const isExpanded = expandedId === p.id;
                            return (
                                <div key={i} className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-4 flex items-center justify-between cursor-pointer" onClick={() => setExpandedId(isExpanded ? null : p.id)}>
                                        <div className="flex items-center gap-4">
                                            <div className="w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm bg-slate-100 text-slate-500">{i+1}</div>
                                            <div><h4 className="font-bold text-slate-800">{p.name}</h4><p className="text-xs text-slate-400">Flight {p.flight} ‚Ä¢ HCP {p.hcp}</p></div>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-2xl font-black text-emerald-700">{gameFormat==='stableford' ? stats.pts : stats.gross}</span>
                                            <span className="text-[10px] font-bold text-slate-400 uppercase">{gameFormat==='stableford' ? 'PTS' : 'STR'}</span>
                                        </div>
                                    </div>
                                    {isExpanded && (
                                        <div className="bg-slate-50 border-t border-slate-100 p-3 animate-slide-down">
                                            <div className="grid grid-cols-9 gap-1 text-center">
                                                {HOLES.map(h => (
                                                    <div key={h.number} className="bg-white rounded p-1 border border-slate-100">
                                                        <div className="text-[8px] font-bold text-slate-400">{h.number}</div>
                                                        <div className="font-bold text-sm text-slate-800">{p.scores[h.number] || '-'}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // 5. WILDLIFE
        const WildlifeView = ({ setView, holeIdx }) => {
            const [sightings, setSightings] = useState([
                { id: 1, animal: 'Crocodile', hole: 13, loc: 'Water Hazard', time: '20m ago', alert: true },
                { id: 2, animal: 'Fish Eagle', hole: 5, time: '1h ago', alert: false }
            ]);
            const [modal, setModal] = useState(null);
            const [loc, setLoc] = useState('');

            const submit = () => {
                if(!loc) return alert("Location?");
                setSightings([{ id: Date.now(), animal: modal==='croc'?'Crocodile':'Bird', hole: holeIdx+1, loc, time: 'Just now', alert: modal==='croc' }, ...sightings]);
                setModal(null); setLoc('');
            };

            return (
                <div className="flex-1 bg-slate-50 h-full safe-pb page-enter flex flex-col">
                    <div className="bg-emerald-900 p-6 pt-12 pb-6 text-white rounded-b-3xl shadow-lg">
                        <div className="flex justify-between items-center">
                            <button onClick={()=>setView('dashboard')}><Icon name="arrow-left" /></button>
                            <h2 className="font-bold">Nature Watch</h2>
                            <div className="w-6"></div>
                        </div>
                    </div>
                    
                    <div className="p-5 flex-1 overflow-y-auto">
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <button onClick={()=>setModal('croc')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-amber-400 transition">
                                <span className="text-3xl">üêä</span><span className="text-xs font-bold text-slate-700">Log Croc</span>
                            </button>
                            <button onClick={()=>setModal('bird')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-sky-400 transition">
                                <span className="text-3xl">ü¶Ö</span><span className="text-xs font-bold text-slate-700">Log Bird</span>
                            </button>
                        </div>

                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Recent Sightings</h3>
                        <div className="space-y-3">
                            {sightings.map(s => (
                                <div key={s.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${s.alert ? 'bg-amber-100' : 'bg-sky-100'}`}>{s.alert?'üêä':'ü¶Ö'}</div>
                                    <div>
                                        <div className="flex items-center gap-2"><span className="font-bold text-sm text-slate-800">{s.animal}</span> <span className="text-[10px] text-slate-400">{s.time}</span></div>
                                        <p className="text-xs text-slate-500">Hole {s.hole} ‚Ä¢ {s.loc || 'General area'}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {modal && (
                        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
                                <h3 className="font-bold text-lg mb-1 text-slate-800">Spotting a {modal==='croc'?'Crocodile':'Bird'}</h3>
                                <p className="text-xs text-slate-500 mb-4">You are on Hole {holeIdx+1}</p>
                                <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm mb-4 outline-none focus:border-emerald-500" placeholder="Where exactly? (e.g. River bank)" value={loc} onChange={e=>setLoc(e.target.value)} autoFocus />
                                <button className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 text-sm font-bold mb-4 flex items-center justify-center gap-2"><Icon name="camera" size={16}/> Add Photo</button>
                                <div className="flex gap-3">
                                    <button onClick={()=>setModal(null)} className="flex-1 py-3 text-sm font-bold text-slate-500">Cancel</button>
                                    <button onClick={submit} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl text-sm font-bold shadow-lg">Submit Log</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 6. CADDY
        const CaddyView = ({ setView }) => {
            const [messages, setMessages] = useState([{ role: 'model', text: "Hello! I'm your Mangais AI Caddy. Ask me about wind, strategy, or rules." }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const ask = async (query) => {
                const userText = query || input;
                if(!userText.trim()) return;
                setMessages(prev => [...prev, { role: 'user', text: userText }]);
                setInput('');
                setLoading(true);

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;
                const prompt = `You are Mangais Caddy. Warn about crocodiles on holes 5, 8, 13, 18. Keep it brief.`;

                try {
                    const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt + "\n\nUser: " + userText }] }] }) });
                    const data = await res.json();
                    if (data.candidates) {
                        setMessages(prev => [...prev, { role: 'model', text: data.candidates[0].content.parts[0].text }]);
                    } else throw new Error("No data");
                } catch(e) {
                    const fallbacks = ["Wind is tricky today. Club up.", "Aim center green, stay safe.", "Watch out for the water hazard!", "Simulation: Safe shot is center fairway."];
                    setMessages(prev => [...prev, { role: 'model', text: "üì° " + fallbacks[Math.floor(Math.random()*fallbacks.length)] }]);
                }
                setLoading(false);
            };

            return (
                <div className="flex-1 bg-slate-50 flex flex-col h-full safe-pb page-enter">
                    <div className="bg-emerald-900 p-4 pt-10 shadow-md text-white flex justify-between items-center sticky top-0 z-10">
                        <button onClick={() => setView('dashboard')}><Icon name="arrow-left" /></button>
                        <h2 className="font-bold">AI Caddy</h2>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 flex flex-col">
                        {messages.map((m, i) => <div key={i} className={`chat-bubble ${m.role === 'user' ? 'user-bubble' : 'ai-bubble'}`}>{m.text}</div>)}
                        {loading && <div className="text-xs text-slate-400 ml-4 animate-pulse">Thinking...</div>}
                        <div ref={scrollRef}></div>
                    </div>
                    <div className="p-4 bg-white border-t border-slate-200">
                        <div className="flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} placeholder="Ask about strategy..." className="flex-1 bg-slate-100 rounded-full px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-emerald-500" onKeyDown={e=>e.key==='Enter' && ask()} />
                            <button onClick={()=>ask()} className="bg-emerald-600 text-white p-3 rounded-full shadow-md"><Icon name="send" size={18} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // 7. NAV
        const NavBar = ({ view, setView }) => (
            <div className="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 pb-8 pt-2 px-6 flex justify-between items-center z-20">
                <button onClick={()=>setView('dashboard')} className={`flex flex-col items-center gap-1 ${view==='dashboard'?'text-emerald-700':'text-slate-400'}`}>
                    <Icon name="home" size={24} strokeWidth={view==='dashboard'?2.5:2} />
                    <span className="text-[10px] font-bold">Home</span>
                </button>
                <button onClick={()=>setView('play')} className="mb-8 w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-200 border-4 border-slate-50 active:scale-95 transition-transform">
                    <Icon name="flag" size={28} fill="currentColor" />
                </button>
                <button onClick={()=>setView('wildlife')} className={`flex flex-col items-center gap-1 ${view==='wildlife'?'text-emerald-700':'text-slate-400'}`}>
                    <Icon name="trees" size={24} strokeWidth={view==='wildlife'?2.5:2} />
                    <span className="text-[10px] font-bold">Nature</span>
                </button>
            </div>
        );

        // --- APP SHELL ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth');
            const [players, setPlayers] = useState([]);
            const [gameFormat, setGameFormat] = useState('stableford');
            const [holeIdx, setHoleIdx] = useState(0);

            useEffect(() => {
                onAuthStateChanged(auth, u => { setUser(u); if(u) setView('dashboard'); });
                lucide.createIcons();
            }, []);

            useEffect(() => { lucide.createIcons(); }, [view]); 

            const login = async () => { try { await signInWithPopup(auth, googleProvider); } catch(e) { alert("Use Guest Mode in Colab"); } };
            const guest = async () => await signInAnonymously(auth);

            if (!user) return (
                <div className="h-full flex flex-col items-center justify-center p-8 bg-[url('https://images.unsplash.com/photo-1593111774240-d529f12cf4bb?w=800')] bg-cover bg-center">
                    <div className="absolute inset-0 bg-emerald-900/90 backdrop-blur-sm"></div>
                    <div className="relative z-10 w-full flex flex-col items-center text-white">
                        <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-emerald-900 mb-6 shadow-2xl">
                            <Icon name="flag" size={40} fill="currentColor" />
                        </div>
                        <h1 className="text-3xl font-black mb-2 tracking-tight">MANGAIS</h1>
                        <p className="text-emerald-200 text-xs font-bold tracking-[0.3em] uppercase mb-12">GameBook Edition</p>
                        <button onClick={login} className="w-full bg-white text-slate-900 py-4 rounded-xl font-bold shadow-xl mb-3 flex items-center justify-center gap-3"><Icon name="user" size={18}/> Sign In</button>
                        <button onClick={guest} className="w-full bg-emerald-800/50 text-emerald-100 py-4 rounded-xl font-bold border border-emerald-500/30">Guest Access</button>
                    </div>
                </div>
            );

            return (
                <>
                    {view === 'dashboard' && <Dashboard user={user} setView={setView} />}
                    {view === 'setup' && <SetupView setView={setView} setPlayers={setPlayers} setGameFormat={setGameFormat} />}
                    {view === 'play' && <GameView players={players} setPlayers={setPlayers} setView={setView} gameFormat={gameFormat} holeIdx={holeIdx} setHoleIdx={setHoleIdx} />}
                    {view === 'leaderboard' && <LeaderboardView players={players} setView={setView} gameFormat={gameFormat} />}
                    {view === 'wildlife' && <WildlifeView setView={setView} holeIdx={holeIdx} />}
                    {view === 'ai-caddy' && <CaddyView setView={setView} />}
                    
                    {(view === 'dashboard' || view === 'play' || view === 'wildlife') && <NavBar view={view} setView={setView} />}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
