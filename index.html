<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mangais Tournament</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = '<div style="color:red; background:white; padding:20px;"><h3>‚ö†Ô∏è Error</h3><p>'+msg+'</p></div>';
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style> 
        body { background-color: #f0fdf4; color: #064e3b; font-family: 'Inter', sans-serif; overflow: hidden; }
        .score-circle { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 12px; }
        .birdie { background-color: #ef4444; color: white; } 
        .par { background-color: #e5e7eb; color: #374151; }   
        .bogey { background-color: #3b82f6; color: white; }   
        .active-player { border: 2px solid #059669; background-color: #ecfdf5; transform: scale(1.05); }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-full flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'firebase/auth';

        const firebaseConfig = {
            apiKey: "AIzaSyDSS05uLPrAKyPt6yBrNt1-xyWmHpJ0L-w",
            authDomain: "mangais-golf.firebaseapp.com",
            projectId: "mangais-golf",
            storageBucket: "mangais-golf.firebasestorage.app",
            messagingSenderId: "107579479973",
            appId: "1:107579479973:web:2a57115ea51d296f3ffa4c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        const API_KEY = "AIzaSyBYd4jCxHZohdIHdu6fCmlU7JFvD2wAL2c"; 

        // --- OFFICIAL MANGAIS DATA ---
        const HOLES = [
            { number: 1, par: 5, si: 16, dist: 485, desc: "Wide fairway.", tip: "Green accessible in 3." },
            { number: 2, par: 4, si: 14, dist: 365, desc: "Straight Par 4.", tip: "Avoid cross bunkers." },
            { number: 3, par: 4, si: 8, dist: 390, desc: "Slight dogleg.", tip: "Play left side." },
            { number: 4, par: 3, si: 12, dist: 145, desc: "Short Par 3.", tip: "Watch the wind." },
            { number: 5, par: 5, si: 2, dist: 520, desc: "Dogleg Left.", tip: "Hardest front hole. üêä Crocs!" },
            { number: 6, par: 4, si: 18, dist: 355, desc: "Easiest hole.", tip: "Birdie chance." },
            { number: 7, par: 4, si: 10, dist: 375, desc: "Tight drive.", tip: "Accuracy over power." },
            { number: 8, par: 3, si: 6, dist: 175, desc: "Over wetland.", tip: "Club up. üêä Crocs!" },
            { number: 9, par: 4, si: 4, dist: 400, desc: "Long finish.", tip: "Avoid water right." },
            { number: 10, par: 4, si: 3, dist: 410, desc: "Long drive needed.", tip: "Tough start to back 9." },
            { number: 11, par: 3, si: 11, dist: 160, desc: "Mid-length.", tip: "Avoid bunkers." },
            { number: 12, par: 5, si: 13, dist: 490, desc: "Recovery chance.", tip: "Go for green in 2?" },
            { number: 13, par: 4, si: 9, dist: 385, desc: "Dogleg Right.", tip: "Keep left. üêä Crocs!" },
            { number: 14, par: 4, si: 7, dist: 395, desc: "Precision key.", tip: "Center fairway." },
            { number: 15, par: 3, si: 17, dist: 135, desc: "Short hole.", tip: "Don't go long." },
            { number: 16, par: 4, si: 5, dist: 405, desc: "Long Par 4.", tip: "Two strong shots." },
            { number: 17, par: 5, si: 1, dist: 540, desc: "Index 1.", tip: "Play safe for Par." },
            { number: 18, par: 4, si: 15, dist: 370, desc: "Clubhouse view.", tip: "Enjoy the walk. üêä Crocs!" }
        ];

        // --- AI CADDY ---
        async function askCaddy(hole, lang) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;
            const prompt = `Mangais Golf Caddy. Hole ${hole.number} (Par ${hole.par}). Tip: ${hole.tip}. Give 1 sentence advice in ${lang}. Mention wind/hazards.`;
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "Play it safe down the middle."; }
        }

        const useAuth = () => {
            const [user, setUser] = useState(null);
            useEffect(() => onAuthStateChanged(auth, setUser), []);
            const loginGoogle = () => signInWithPopup(auth, googleProvider).catch(e => e.code === 'auth/unauthorized-domain' ? alert("‚ö†Ô∏è Please use 'Visitor Access' in Colab.") : alert(e.message));
            const loginGuest = () => signInAnonymously(auth).catch(e => alert(e.message));
            const logout = () => signOut(auth);
            return { user, loginGoogle, loginGuest, logout };
        };

        function App() {
            const { user, loginGoogle, loginGuest, logout } = useAuth();
            const [view, setView] = useState('auth'); 
            
            // --- TOURNAMENT STATE ---
            const [players, setPlayers] = useState([]); // [{id:1, name:"Tiger", hcp:0, scores:{}}]
            const [activePlayerId, setActivePlayerId] = useState(0); // Index of player being scored
            const [currentHole, setCurrentHole] = useState(1);
            const [caddyMsg, setCaddyMsg] = useState("");
            const [loading, setLoading] = useState(false);
            const [lang, setLang] = useState('en');

            // Setup State
            const [setupName, setSetupName] = useState("");
            const [setupHcp, setSetupHcp] = useState(18);

            useEffect(() => { 
                if (user && players.length === 0) {
                    setPlayers([{ id: 0, name: user.displayName || "You", hcp: 18, scores: {} }]);
                    setView('home'); 
                }
            }, [user]);

            const holeInfo = HOLES.find(h => h.number === currentHole);
            const activePlayer = players[activePlayerId] || players[0];
            const currentScore = activePlayer?.scores[currentHole] || holeInfo?.par || 4;

            // --- SCORING LOGIC ---
            const updateScore = (val) => {
                const newPlayers = [...players];
                const p = newPlayers[activePlayerId];
                const oldScore = p.scores[currentHole] || holeInfo.par;
                p.scores[currentHole] = Math.max(1, oldScore + val);
                setPlayers(newPlayers);
            };

            const getPoints = (h, score, hcp) => {
                let free = 0;
                if (hcp >= h.si) free = 1;
                if (hcp - 18 >= h.si) free = 2;
                return Math.max(0, h.par - (score - free) + 2);
            };

            const getTotalPoints = (p) => {
                return Object.entries(p.scores).reduce((acc, [hNum, score]) => {
                    const hole = HOLES.find(h => h.number == hNum);
                    return acc + getPoints(hole, score, p.hcp);
                }, 0);
            };

            const addPlayer = () => {
                if(players.length >= 4) return alert("Max 4 players allowed.");
                if(!setupName) return alert("Enter a name.");
                setPlayers([...players, { id: players.length, name: setupName, hcp: setupHcp, scores: {} }]);
                setSetupName("");
                alert("Player Added!");
            };

            const handleAskCaddy = async () => {
                setLoading(true);
                const advice = await askCaddy(holeInfo, lang);
                setCaddyMsg(advice);
                setLoading(false);
            };

            // --- VIEWS ---

            if (!user) return (
                <div className="h-full flex flex-col items-center justify-center p-8 bg-emerald-900 text-white">
                    <div className="text-6xl mb-4">üèÜ</div>
                    <h1 className="text-3xl font-bold mb-2">MANGAIS</h1>
                    <p className="text-emerald-300 text-xs mb-8 uppercase tracking-widest">Tournament Edition</p>
                    <button onClick={loginGoogle} className="w-full bg-white text-emerald-900 py-3 rounded-xl font-bold mb-3 shadow-lg">Google Sign In</button>
                    <button onClick={loginGuest} className="w-full border border-emerald-500 py-3 rounded-xl font-bold">Visitor Access</button>
                </div>
            );

            if (view === 'setup') return (
                <div className="h-full flex flex-col bg-slate-50 p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Tournament Setup</h2>
                        <button onClick={() => setView('home')} className="text-slate-400 font-bold">Close</button>
                    </div>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-sm mb-6">
                        <h3 className="font-bold mb-4">Add Players (Max 4)</h3>
                        <div className="space-y-3">
                            <input value={setupName} onChange={e=>setSetupName(e.target.value)} placeholder="Player Name" className="w-full p-3 bg-slate-100 rounded-xl" />
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-slate-500">HCP:</span>
                                <input type="number" value={setupHcp} onChange={e=>setSetupHcp(Number(e.target.value))} className="w-20 p-3 bg-slate-100 rounded-xl" />
                            </div>
                            <button onClick={addPlayer} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">+ Add Player</button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">Current Flight</h3>
                        {players.map((p, i) => (
                            <div key={i} className="flex justify-between bg-white p-4 rounded-xl shadow-sm">
                                <span className="font-bold">{p.name}</span>
                                <span className="text-emerald-600 font-bold">HCP {p.hcp}</span>
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={() => setView('play')} className="mt-auto w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg">Start Round üöÄ</button>
                </div>
            );

            if (view === 'home') return (
                <div className="h-full flex flex-col bg-slate-50">
                    <div className="h-56 bg-emerald-800 relative p-6 flex flex-col justify-end shadow-lg">
                        <div className="absolute top-6 right-6 flex gap-2">
                            <button onClick={() => setLang(lang==='en'?'pt':'en')} className="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold">{lang.toUpperCase()}</button>
                            <button onClick={logout} className="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold">Exit</button>
                        </div>
                        <h1 className="text-3xl font-bold text-white mb-1">Mangais Golf</h1>
                        <p className="text-emerald-200 text-sm">Tournament Mode Active</p>
                    </div>
                    <div className="flex-1 p-6 -mt-6 relative z-10 space-y-4">
                        <button onClick={() => setView('play')} className="w-full bg-white p-6 rounded-2xl shadow-xl flex items-center justify-between border border-emerald-50">
                            <div className="text-left">
                                <span className="text-xs font-bold text-emerald-600 uppercase">Resume</span>
                                <span className="block text-2xl font-black text-slate-800">Play Golf</span>
                            </div>
                            <span className="text-4xl">‚õ≥</span>
                        </button>
                        <button onClick={() => setView('setup')} className="w-full bg-emerald-50 p-6 rounded-2xl shadow-sm flex items-center gap-4 border border-emerald-100">
                            <span className="text-2xl">üë•</span>
                            <div className="text-left">
                                <span className="font-bold text-emerald-900">Manage Flight</span>
                                <span className="block text-xs text-emerald-600">{players.length} Players Ready</span>
                            </div>
                        </button>
                        <button onClick={() => setView('leaderboard')} className="w-full bg-white p-6 rounded-2xl shadow-sm flex items-center gap-4 border border-slate-100">
                            <span className="text-2xl">üèÜ</span>
                            <span className="font-bold text-slate-700">Leaderboard</span>
                        </button>
                    </div>
                </div>
            );

            if (view === 'play') return (
                <div className="h-full flex flex-col bg-slate-50">
                    {/* Header */}
                    <div className="bg-white p-4 shadow-sm flex justify-between items-center z-10">
                        <button onClick={() => setView('home')} className="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full">üè†</button>
                        <div className="text-center">
                            <h2 className="font-black text-xl">HOLE {currentHole}</h2>
                            <p className="text-[10px] font-bold text-slate-500 uppercase">Par {holeInfo.par} ‚Ä¢ SI {holeInfo.si} ‚Ä¢ {holeInfo.dist}m</p>
                        </div>
                        <button onClick={() => setView('leaderboard')} className="text-2xl">üèÜ</button>
                    </div>

                    {/* Player Switcher */}
                    <div className="flex overflow-x-auto p-2 gap-2 bg-white border-b border-slate-100 no-scrollbar">
                        {players.map((p, i) => (
                            <button key={i} onClick={() => setActivePlayerId(i)} 
                                className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition ${activePlayerId === i ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>
                                {p.name}
                            </button>
                        ))}
                    </div>

                    {/* Main Scoring */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6">
                        <div className="bg-white w-full max-w-xs p-6 rounded-3xl shadow-xl border border-slate-100 text-center mb-6">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Scoring for {activePlayer.name}</p>
                            <div className="flex items-center justify-between mb-6">
                                <button onClick={() => updateScore(-1)} className="w-12 h-12 rounded-full bg-slate-100 text-xl font-bold">-</button>
                                <div className="text-7xl font-black text-slate-800">{currentScore}</div>
                                <button onClick={() => updateScore(1)} className="w-12 h-12 rounded-full bg-emerald-600 text-white text-xl font-bold">+</button>
                            </div>
                            <div className="inline-block bg-slate-100 px-4 py-1 rounded-full text-xs font-bold text-slate-600">
                                {getPoints(holeInfo, currentScore, activePlayer.hcp)} Pts ‚Ä¢ Net {currentScore - (activePlayer.hcp >= holeInfo.si ? 1 : 0)}
                            </div>
                        </div>

                        {/* AI Advice */}
                        <div className="w-full max-w-xs space-y-2">
                            {caddyMsg && <div className="bg-emerald-50 p-3 rounded-xl text-xs text-emerald-800 border border-emerald-100">üí° {caddyMsg}</div>}
                            <button onClick={handleAskCaddy} disabled={loading} className="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                <span>ü§ñ</span> {loading ? "..." : "Tiger Strategy"}
                            </button>
                        </div>
                    </div>

                    <div className="p-4 bg-white border-t">
                        <button onClick={() => { if(currentHole<18) { setCurrentHole(c=>c+1); setCaddyMsg(""); } }} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Next Hole ‚û°Ô∏è</button>
                    </div>
                </div>
            );

            if (view === 'leaderboard') return (
                <div className="h-full flex flex-col bg-white">
                    <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                        <button onClick={() => setView('play')} className="font-bold text-slate-500">Back</button>
                        <h2 className="font-bold text-lg">Leaderboard</h2>
                        <div className="w-8"></div>
                    </div>
                    <div className="p-4 space-y-3 bg-slate-50 flex-1">
                        {players.sort((a,b) => getTotalPoints(b) - getTotalPoints(a)).map((p, i) => (
                            <div key={i} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-emerald-50">
                                <div className="flex items-center gap-4">
                                    <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${i===0 ? 'bg-yellow-400 text-yellow-900' : 'bg-slate-100 text-slate-500'}`}>{i+1}</span>
                                    <div>
                                        <span className="block font-bold text-slate-800">{p.name}</span>
                                        <span className="text-xs text-slate-400">HCP {p.hcp}</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <span className="block text-2xl font-black text-emerald-600">{getTotalPoints(p)}</span>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase">Points</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
