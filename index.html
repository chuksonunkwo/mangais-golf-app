<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mangais Tournament Pro</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = '<div style="color:white; background:red; padding:20px; font-family:sans-serif;"><h3>‚ö†Ô∏è App Error</h3><p>' + msg + '</p><p>Line: ' + line + '</p></div>';
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style> 
        /* FIX 1: Prevent scrolling on body to handle mobile heights better */
        body { background-color: #f8fafc; color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        
        .score-circle { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 800; font-size: 15px; border: 1px solid rgba(0,0,0,0.1); }
        .birdie { background-color: #ef4444; color: white; border: none; } 
        .par { background-color: #e2e8f0; color: #334155; }   
        .bogey { background-color: #3b82f6; color: white; border: none; }   
        
        .active-player { border: 2px solid #059669; background-color: #ecfdf5; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); color: #065f46; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .caddy-bubble { position: relative; background: #064e3b; color: white; border-radius: 16px; border-bottom-left-radius: 4px; padding: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .caddy-bubble::after { content: ''; position: absolute; bottom: 0; left: -8px; width: 0; height: 0; border: 8px solid transparent; border-right-color: #064e3b; border-bottom: 0; margin-bottom: 0; }
        
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); } 100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); } }
        .btn-pulse { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'firebase/auth';

        const firebaseConfig = {
            apiKey: "AIzaSyDSS05uLPrAKyPt6yBrNt1-xyWmHpJ0L-w",
            authDomain: "mangais-golf.firebaseapp.com",
            projectId: "mangais-golf",
            storageBucket: "mangais-golf.firebasestorage.app",
            messagingSenderId: "107579479973",
            appId: "1:107579479973:web:2a57115ea51d296f3ffa4c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        const API_KEY = "AIzaSyBYd4jCxHZohdIHdu6fCmlU7JFvD2wAL2c"; 

        const HOLES = [
            { number: 1, par: 5, si: 16, dist: 485, desc: "Opening Par 5.", tip: "Green accessible in 3. Stay center." },
            { number: 2, par: 4, si: 14, dist: 365, desc: "Straight Par 4.", tip: "Watch out for cross bunkers." },
            { number: 3, par: 4, si: 8, dist: 390, desc: "Slight Dogleg.", tip: "Left side opens up the green." },
            { number: 4, par: 3, si: 12, dist: 145, desc: "Short Par 3.", tip: "Club selection key due to wind." },
            { number: 5, par: 5, si: 2, dist: 520, desc: "Dogleg Left.", tip: "Hardest front hole. üêä Croc Risk!" },
            { number: 6, par: 4, si: 18, dist: 355, desc: "Easiest Hole.", tip: "Great birdie opportunity." },
            { number: 7, par: 4, si: 10, dist: 375, desc: "Tight Drive.", tip: "Accuracy over distance here." },
            { number: 8, par: 3, si: 6, dist: 175, desc: "Over Wetland.", tip: "Check wind carefully. üêä Croc Risk!" },
            { number: 9, par: 4, si: 4, dist: 400, desc: "Long Finish.", tip: "Avoid water on the right." },
            { number: 10, par: 4, si: 3, dist: 410, desc: "Tough Start.", tip: "Long drive required." },
            { number: 11, par: 3, si: 11, dist: 160, desc: "Mid-length.", tip: "Avoid the greenside bunkers." },
            { number: 12, par: 5, si: 13, dist: 490, desc: "Recovery Chance.", tip: "Go for green in 2 if confident." },
            { number: 13, par: 4, si: 9, dist: 385, desc: "Dogleg Right.", tip: "Keep left off tee. üêä Croc Risk!" },
            { number: 14, par: 4, si: 7, dist: 395, desc: "Precision.", tip: "Fairway center is the goal." },
            { number: 15, par: 3, si: 17, dist: 135, desc: "Shortest Hole.", tip: "Don't go long." },
            { number: 16, par: 4, si: 5, dist: 405, desc: "Long Par 4.", tip: "Requires two strong shots." },
            { number: 17, par: 5, si: 1, dist: 540, desc: "Index 1.", tip: "Play safe for Par. Avoid big numbers." },
            { number: 18, par: 4, si: 15, dist: 370, desc: "Home Hole.", tip: "Enjoy the walk. üêä Croc Risk!" }
        ];

        async function askCaddy(holeInfo, player, lang) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;
            let playStyle = player.hcp < 10 ? "Aggressive (Go for birdie)" : player.hcp > 20 ? "Safe (Avoid hazards)" : "Balanced";
            const prompt = `Act as Mangais Caddy. Player: ${player.name} (HCP ${player.hcp}). Style: ${playStyle}. Hole ${holeInfo.number} (${holeInfo.dist}m, Par ${holeInfo.par}). Tip: ${holeInfo.tip}. Give 1 sentence of strategic advice. Mention hazards/wind. Lang: ${lang}.`;
            try {
                const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "Play it smart. Keep it on the fairway."; }
        }

        const useAuth = () => {
            const [user, setUser] = useState(null);
            useEffect(() => onAuthStateChanged(auth, setUser), []);
            const loginGoogle = () => signInWithPopup(auth, googleProvider).catch(e => alert(e.message));
            const loginGuest = () => signInAnonymously(auth).catch(e => alert(e.message));
            const logout = () => signOut(auth);
            return { user, loginGoogle, loginGuest, logout };
        };

        function App() {
            const { user, loginGoogle, loginGuest, logout } = useAuth();
            const [view, setView] = useState('auth'); 
            const [players, setPlayers] = useState([]); 
            const [activePlayerId, setActivePlayerId] = useState(0); 
            const [currentHole, setCurrentHole] = useState(1);
            const [caddyMsg, setCaddyMsg] = useState("");
            const [loading, setLoading] = useState(false);
            const [lang, setLang] = useState('en');
            const [setupName, setSetupName] = useState("");
            const [setupHcp, setSetupHcp] = useState(18);

            useEffect(() => { 
                if (user && players.length === 0) {
                    setPlayers([{ id: 0, name: user.displayName ? user.displayName.split(' ')[0] : "You", hcp: 18, scores: {} }]);
                    setView('home'); 
                }
            }, [user]);

            const holeInfo = HOLES.find(h => h.number === currentHole) || HOLES[0];
            const activePlayer = players[activePlayerId] || players[0]; 
            const currentScore = activePlayer?.scores[currentHole] || holeInfo.par;

            // --- FIX 2: STATE IMMUTABILITY (Prevents "Missing Breakdown" Issue) ---
            const updateScore = (val) => {
                setPlayers(prevPlayers => {
                    const newPlayers = [...prevPlayers];
                    // Create a Deep Copy of the active player to ensure React detects the change
                    const updatedPlayer = { ...newPlayers[activePlayerId] };
                    updatedPlayer.scores = { ...updatedPlayer.scores };
                    
                    const oldScore = updatedPlayer.scores[currentHole] || holeInfo.par;
                    updatedPlayer.scores[currentHole] = Math.max(1, oldScore + val);
                    
                    newPlayers[activePlayerId] = updatedPlayer;
                    return newPlayers;
                });
            };

            const getPoints = (h, score, hcp) => {
                if (!score) return 0;
                let free = 0;
                if (hcp >= h.si) free = 1;
                if (hcp - 18 >= h.si) free = 2;
                return Math.max(0, h.par - (score - free) + 2);
            };

            const getTotals = (p) => {
                let gross = 0, net = 0, pts = 0;
                Object.entries(p.scores).forEach(([hNum, score]) => {
                    const hole = HOLES.find(h => h.number == hNum);
                    if (!hole) return;
                    gross += score;
                    let free = 0;
                    if (p.hcp >= hole.si) free = 1;
                    if (p.hcp - 18 >= hole.si) free = 2;
                    net += Math.max(1, score - free);
                    pts += getPoints(hole, score, p.hcp);
                });
                return { gross, net, pts };
            };

            const handleAskCaddy = async () => {
                setLoading(true);
                const advice = await askCaddy(holeInfo, activePlayer, lang);
                setCaddyMsg(advice);
                setLoading(false);
            };

            const addPlayer = () => {
                if(players.length >= 4) return alert("Max 4 players.");
                if(!setupName) return alert("Name required.");
                setPlayers([...players, { id: players.length, name: setupName, hcp: setupHcp, scores: {} }]);
                setSetupName("");
                setSetupHcp(18);
            };

            // --- VIEWS ---
            if (!user) return (
                // FIX 1: Use h-[100dvh] for mobile browsers
                <div className="h-[100dvh] flex flex-col items-center justify-center p-8 bg-emerald-900 text-white bg-[url('https://picsum.photos/800/1200?random=golf')] bg-cover bg-blend-overlay">
                    <div className="text-6xl mb-4 animate-bounce">üèÜ</div>
                    <h1 className="text-4xl font-black mb-2">MANGAIS</h1>
                    <p className="text-emerald-200 text-xs mb-8 uppercase tracking-widest font-bold">Tournament Pro</p>
                    <button onClick={loginGoogle} className="w-full bg-white text-emerald-900 py-4 rounded-xl font-bold mb-3 shadow-xl">Google Sign In</button>
                    <button onClick={loginGuest} className="w-full border border-white/30 text-white py-4 rounded-xl font-bold backdrop-blur-sm">Visitor Access</button>
                </div>
            );

            if (view === 'home') return (
                <div className="h-[100dvh] flex flex-col bg-slate-50">
                    <div className="h-64 bg-emerald-800 relative overflow-hidden rounded-b-[40px] shadow-lg shrink-0">
                        <div className="absolute inset-0 bg-black/20"></div>
                        <div className="absolute top-6 right-6 flex gap-2 z-10">
                            <button onClick={() => setLang(lang==='en'?'pt':'en')} className="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-md">{lang.toUpperCase()}</button>
                            <button onClick={logout} className="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-md">Exit</button>
                        </div>
                        <div className="absolute bottom-8 left-6 text-white z-10">
                            <h1 className="text-3xl font-bold">{user.displayName ? user.displayName.split(' ')[0] : 'Golfer'}</h1>
                            <p className="opacity-90 text-sm mt-1">{players.length > 1 ? `${players.length} Players Active` : 'Solo Round'}</p>
                        </div>
                    </div>
                    <div className="flex-1 p-6 -mt-10 relative z-10 space-y-4">
                        <button onClick={() => setView('play')} className="w-full bg-white p-6 rounded-2xl shadow-xl flex items-center justify-between border border-emerald-50 active:scale-95 transition">
                            <div><span className="text-xs font-bold text-emerald-600 uppercase block mb-1">Resume</span><span className="block text-2xl font-black text-slate-800">Play Golf</span></div>
                            <div className="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-2xl">‚õ≥</div>
                        </button>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => setView('setup')} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 active:scale-95 transition"><span className="text-3xl">üë•</span><span className="font-bold text-slate-700 text-sm">Flight</span></button>
                            <button onClick={() => setView('leaderboard')} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 active:scale-95 transition"><span className="text-3xl">üèÜ</span><span className="font-bold text-slate-700 text-sm">Standings</span></button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'setup') return (
                <div className="h-[100dvh] flex flex-col bg-slate-50 p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Flight Setup</h2>
                        <button onClick={() => setView('home')} className="text-slate-400 font-bold">Close</button>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-emerald-50">
                        <h3 className="font-bold mb-4 text-emerald-900">Add Player</h3>
                        <div className="space-y-3">
                            <input value={setupName} onChange={e=>setSetupName(e.target.value)} placeholder="Player Name" className="w-full p-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-slate-500">HCP:</span>
                                <input type="number" value={setupHcp} onChange={e=>setSetupHcp(Number(e.target.value))} className="w-20 p-3 bg-slate-100 rounded-xl text-center font-bold" />
                            </div>
                            <button onClick={addPlayer} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold active:scale-95 transition">+ Add to Flight</button>
                        </div>
                    </div>
                    <div className="space-y-2 flex-1 overflow-y-auto">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">Current Flight</h3>
                        {players.map((p, i) => (
                            <div key={i} className="flex justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                <span className="font-bold text-slate-800">{p.name}</span>
                                <span className="text-emerald-600 font-bold text-sm bg-emerald-50 px-2 py-1 rounded">HCP {p.hcp}</span>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => setView('play')} className="mt-4 w-full bg-emerald-900 text-white py-4 rounded-xl font-bold shadow-lg">Start Round üöÄ</button>
                </div>
            );

            if (view === 'play') return (
                <div className="h-[100dvh] flex flex-col bg-slate-50">
                    <div className="bg-white p-4 shadow-sm flex justify-between items-center z-10 border-b border-gray-100 shrink-0">
                        <button onClick={() => setView('home')} className="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-slate-600">üè†</button>
                        <div className="text-center">
                            <h2 className="font-black text-xl text-slate-800">HOLE {currentHole}</h2>
                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Par {holeInfo.par} ‚Ä¢ SI {holeInfo.si} ‚Ä¢ {holeInfo.dist}m</p>
                        </div>
                        <button onClick={() => setView('leaderboard')} className="text-2xl">üèÜ</button>
                    </div>

                    <div className="bg-white border-b border-slate-100 p-3 overflow-x-auto no-scrollbar flex gap-2 shadow-inner shrink-0">
                        {players.map((p, i) => (
                            <button key={i} onClick={() => setActivePlayerId(i)} 
                                className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition flex items-center gap-2 ${activePlayerId === i ? 'active-player' : 'bg-slate-100 text-slate-400'}`}>
                                {p.name}
                                {activePlayerId === i && <span className="w-2 h-2 bg-emerald-500 rounded-full"></span>}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-6 relative overflow-y-auto w-full">
                        <div className="bg-white w-full max-w-xs p-6 rounded-3xl shadow-xl border border-emerald-50 text-center mb-6 relative overflow-hidden shrink-0">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-emerald-500"></div>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Scoring for <span className="text-emerald-600">{activePlayer?.name}</span></p>
                            <div className="flex items-center justify-between mb-6">
                                <button onClick={() => updateScore(-1)} className="w-14 h-14 rounded-full bg-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-200 transition">-</button>
                                <div className="text-8xl font-black text-slate-800 tabular-nums leading-none">{currentScore}</div>
                                <button onClick={() => updateScore(1)} className="w-14 h-14 rounded-full bg-emerald-600 text-white text-2xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition">+</button>
                            </div>
                            <div className="inline-flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-full text-xs font-bold text-slate-600">
                                <span>{getPoints(holeInfo, currentScore, activePlayer?.hcp)} Pts</span>
                                <span className="w-1 h-1 bg-slate-400 rounded-full"></span>
                                <span>Net {currentScore - ((activePlayer?.hcp >= holeInfo.si) ? 1 : 0)}</span>
                            </div>
                        </div>

                        <div className="w-full max-w-xs space-y-3 shrink-0 pb-4">
                            {caddyMsg && (
                                <div className="caddy-bubble animate-in slide-in-from-bottom-2">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="text-emerald-200 font-bold text-[10px] uppercase">Tiger Strategy</span>
                                        <span className="text-xs opacity-50">ü§ñ</span>
                                    </div>
                                    <p className="text-sm font-medium leading-snug">"{caddyMsg}"</p>
                                </div>
                            )}
                            <button onClick={handleAskCaddy} disabled={loading} className="w-full py-4 bg-white border border-slate-200 rounded-2xl font-bold text-sm text-slate-700 shadow-sm flex items-center justify-center gap-2 active:scale-95 transition">
                                {loading ? <span className="animate-spin">‚è≥ Thinking...</span> : <span>ü§ñ Ask Caddy</span>}
                            </button>
                        </div>
                    </div>

                    <div className="p-4 bg-white border-t border-slate-200 shrink-0 safe-area-pb">
                        {currentHole === 18 ? (
                            <button onClick={() => { if(window.confirm("‚úçÔ∏è Sign Scorecard & Finish Round?")) setView('leaderboard'); }} className="w-full bg-emerald-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg btn-pulse">
                                ‚úçÔ∏è SIGN SCORECARD
                            </button>
                        ) : (
                            <button onClick={() => { setCurrentHole(c=>c+1); setCaddyMsg(""); }} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">
                                NEXT HOLE ‚û°Ô∏è
                            </button>
                        )}
                    </div>
                </div>
            );

            if (view === 'leaderboard') return (
                <div className="h-[100dvh] flex flex-col bg-white">
                    <div className="bg-emerald-900 p-6 rounded-b-3xl shadow-lg shrink-0 text-white">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => setView('play')} className="text-emerald-200 hover:text-white"><span className="text-2xl">‚Üê</span></button>
                            <h2 className="font-bold text-lg uppercase tracking-widest">Final Standings</h2>
                            <div className="w-6"></div>
                        </div>
                        {players.length > 0 && (() => {
                            // SAFE SORTING: Copy array first to avoid state mutation bug!
                            const sorted = [...players].sort((a,b) => getTotals(b).pts - getTotals(a).pts);
                            const winner = sorted[0];
                            const winStats = getTotals(winner);
                            return (
                                <div className="text-center pb-2">
                                    <div className="w-20 h-20 bg-yellow-400 rounded-full flex items-center justify-center text-4xl mx-auto mb-3 border-4 border-emerald-800 shadow-xl">üèÜ</div>
                                    <h3 className="text-3xl font-black">{winner.name}</h3>
                                    <p className="text-emerald-300 text-xs font-bold uppercase mb-4">Tournament Champion</p>
                                    <div className="inline-flex bg-emerald-800/50 rounded-lg p-3 gap-6 border border-emerald-700">
                                        <div className="text-center"><span className="block text-xl font-bold">{winStats.gross}</span><span className="text-[9px] uppercase opacity-70">Gross</span></div>
                                        <div className="text-center"><span className="block text-xl font-bold text-yellow-400">{winStats.pts}</span><span className="text-[9px] uppercase opacity-70 text-yellow-400">Points</span></div>
                                    </div>
                                </div>
                            );
                        })()}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 bg-slate-50">
                        <div className="grid grid-cols-[30px_1fr_40px_40px_40px] px-2 mb-2 text-[10px] font-bold text-slate-400 uppercase text-center">
                            <span>#</span><span className="text-left">Player</span><span>Gro</span><span>Net</span><span>Pts</span>
                        </div>
                        <div className="space-y-2">
                            {[...players].sort((a,b) => getTotals(b).pts - getTotals(a).pts).map((p, i) => {
                                const stats = getTotals(p);
                                return (
                                    <div key={i} className="bg-white rounded-xl shadow-sm border border-slate-100 p-3 grid grid-cols-[30px_1fr_40px_40px_40px] items-center text-center">
                                        <span className={`w-6 h-6 flex items-center justify-center rounded text-xs font-bold mx-auto ${i===0 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100 text-slate-500'}`}>{i+1}</span>
                                        <div className="text-left overflow-hidden">
                                            <span className="block font-bold text-slate-800 text-sm truncate">{p.name}</span>
                                            <span className="text-[9px] text-slate-400">HCP {p.hcp}</span>
                                        </div>
                                        <span className="text-sm font-bold text-slate-600">{stats.gross}</span>
                                        <span className="text-sm font-bold text-slate-600">{stats.net}</span>
                                        <span className="text-lg font-black text-emerald-600">{stats.pts}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="p-4 bg-white border-t border-slate-200 shrink-0">
                        <button onClick={() => setView('home')} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg">Back to Club üè†</button>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
